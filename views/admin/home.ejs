<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Nest Dashboard</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta property="og:title" content="" />
        <meta property="og:type" content="" />
        <meta property="og:url" content="" />
        <meta property="og:image" content="" />
        <!-- Favicon -->

        <!-- Template CSS -->
        <link href="https://cdn.jsdelivr.net/npm/remixicon@3.6.0/fonts/remixicon.css" rel="stylesheet">
        <link href="/css/main.css?v=1.1" rel="stylesheet" type="text/css" />

    </head>

    <body>
        <div class="screen-overlay"></div>
        <aside class="navbar-aside" id="offcanvas_aside">
            <div class="aside-top">
                <a href="index.html" class="brand-wrap">
                    <h3>Admin</h3>
                </a>
                <div>
                    <button class="btn btn-icon btn-aside-minimize"><i class="text-muted material-icons md-menu_open"></i></button>
                </div>
            </div>
            <nav>
                <ul class="menu-aside">
                    <li class="menu-item active">
                        <a class="menu-link" href="/admin/home?filter=Weekly">
                            <i class="icon material-icons md-home"></i>
                            <span class="text">Dashboard</span>
                        </a>
                    </li>
                    <li class="menu-item has-submenu">
                        <a class="menu-link" href="page-products-list">
                            <i class="icon material-icons md-shopping_bag"></i>
                            <span class="text">Products</span>
                        </a>
                        <div class="submenu">
                            <a href="/admin/page-products-list">Product List</a>
                            <!-- <a href="page-products-grid.html">Product grid</a>
                            <a href="page-products-grid-2.html">Product grid 2</a>
                            <a href="page-categories.html">Categories</a> -->
                        </div>
                    </li>
                    
                    <li class="menu-item has-submenu">
                        <a class="menu-link" href="/admin/user-list">
                            <i class="icon material-icons md-person"></i>
                            <span class="text"> User </span>
                        </a>
                        <div class="submenu">
                            <a href="/admin/user-list">User list</a>
                        </div>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href="/admin/category">
                            <i class="icon material-icons md-comment"></i>
                            <span class="text">Category</span>
                        </a>
                    </li>
                    <li class="menu-item ">
                        <a class="menu-link" href="/admin/order-list">
                            <i class="icon material-icons md-shopping_cart"></i>
                            <span class="text">Orders</span>
                        </a>
                       
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" disabled href="/admin/coupon">
                            <i style=" color: rgb(195, 198, 201);" class="ri-coupon-2-fill ri-xl"></i>
                            <span style="margin-left: 10px;" class="text">Coupon</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href="/admin/banner">
                            <i class="icon material-icons md-image"></i>
                            <span class="text">Banners</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href="/admin/refferal">
                            <i class="icon material-icons md-image"></i>
                          
                            <span class="text">refferal</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a class="menu-link" href="/admin/offer">
                            <i class="icon material-icons md-attach_money"></i>
                          
                            <span class="text">offer</span>
                        </a>
                    </li>
                </ul> 
                <hr />
                <br />
                <br />
            </nav>
        </aside>
        <main class="main-wrap">
            <header class="main-header navbar">
                <div class="col-search">
                    <form class="searchform">
                        <div class="input-group">
                            <input list="search_terms" type="text" class="form-control" placeholder="Search term" />
                            <button class="btn btn-light bg" type="button"><i class="material-icons md-search"></i></button>
                        </div>
                        <datalist id="search_terms">
                            <option value="Products"></option>
                            <option value="New orders"></option>
                            <option value="Apple iphone"></option>
                            <option value="Ahmed Hassan"></option>
                        </datalist>
                    </form>
                </div>
                <div class="col-nav">
                    <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"><i class="material-icons md-apps"></i></button>
                    <ul class="nav">
                        <li class="nav-item">
                            <form action="/admin/home/signout" method="post">
                                <button type="submit">
                                    logout
                                </button>
                            </form>
                        </li>  
                    </ul>
                </div>
            </header>
            <section class="content-main">
                <div class="row">
                    <div class="col-lg-3">
                        <div class="card card-body mb-4">
                            <article class="icontext">
                                <span class="icon icon-sm rounded-circle bg-primary-light"><i class="text-primary material-icons md-monetization_on"></i></span>
                                <div class="text">
                                    <h6 class="mb-1 card-title">Revenue</h6>
                                     <%=revenue[0].total%>
                                    <span class="text-sm"> Shipping fees are not included </span>
                                </div>
                            </article>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="card card-body mb-4">
                            <article class="icontext">
                                <span class="icon icon-sm rounded-circle bg-success-light"><i class="text-success material-icons md-local_shipping"></i></span>
                                <div class="text">
                                    <h6 class="mb-1 card-title">Orders</h6>
                                     <%=order%>
                                    <span class="text-sm"> Excluding orders in transit </span>
                                </div>
                            </article>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="card card-body mb-4">
                            <article class="icontext">
                                <span class="icon icon-sm rounded-circle bg-warning-light"><i class="text-warning material-icons md-qr_code"></i></span>
                                <div class="text">
                                    <h6 class="mb-1 card-title">Products</h6>
                                     <%=productCount%>
                                    <span class="text-sm"> listed products</span>
                                </div>
                            </article>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="card card-body mb-4" style="display: flex; justify-content: center; align-items: center;">
                            <button id="cust_btn" type="button" data-toggle="modal" data-target="#exampleModalCenter" class="mb-4 bg-success border-0 p-2 rounded fw-bold ">
                                Download sales report 
                            </button> 
                        </div>
                    </div>
                     
                </div>

                <% if(message){ %>
                <div style="display: flex; justify-content: center; align-items: center;" class="text-danger fw-bold">
                    <%=message%>
                </div>
                <% } %>

                 
<div class="container">
    
    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog">
      <div class="modal-dialog">
      
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Modal Header</h4>
          </div>
          <div class="modal-body">
            <p>Some text in the modal.</p>
            <form action="/admin/downloadSalesReport" method="get" class="row" id="downloadSalesForm">
                <p class="text-danger" id="date-label"></p>
                <div class="mb-3 col">
                  <label for="fromDate" class="col-form-label">From:</label>
                  <input type="date" class="form-control" id="fromDate" name="fromDate"required>
                </div>
                <div class="mb-3 col">
                  <label for="toDate" class="col-form-label">To:</label>
                  <input type="date" class="form-control" id="toDate" name="toDate" required>
                </div>
            </form>
          </div>


          <div class="modal-footer">
            <button type="button" class="btn btn-success" onclick="downloadSalesReport()">Download</button>

            <button id="close-button" type="button" class="btn btn btn-danger" data-dismiss="modal">Close</button>
          </div>
        </div>
        
      </div>
    </div>
    
  </div>
   

                 <div class="row">
                    <div class="col-xl-8 col-lg-12">
        
                       
                        <div class="card mb-4">
                            <article class="card-body">
                                <h5 class="card-title">Sale statistics</h5>
                               
                                    <select name="" id="select-btn">
                                        <%if(typeof req !== 'undefined'){%>
                                        <% if(req.query.filter === 'Weekly'){ %>
                                            <option selected value="/admin/home?filter=Weekly">weekly</option>
                                            <option  id="month" value="/admin/home?filter=Monthly">monthly</option>
                                            <option  id="year" value="/admin/home?filter=Yearly">yearly</option>
                                        <% }else if(req.query.filter === 'Monthly'){ %>
                                            <option value="/admin/home?filter=Weekly">weekly</option>
                                            <option selected id="month" value="/admin/home?filter=Monthly">monthly</option>
                                            <option id="year" value="/admin/home?filter=Yearly">yearly</option>
                                        <%}else{%>
                                            <option value="/admin/home?filter=Weekly">weekly</option>
                                            <option id="month" value="/admin/home?filter=Monthly">monthly</option>
                                            <option selected id="year" value="/admin/home?filter=Yearly">yearly</option>
                                        <%}%>
                                    <%}else{%>
                                        <option value="/admin/home?filter=Weekly">weekly</option>
                                        <option id="month" value="/admin/home?filter=Monthly">monthly</option>
                                        <option id="year" value="/admin/home?filter=Yearly">yearly</option>
                                    <%}%>
                                                              
                                    </select>
                                  
                                <canvas id="myChart" height="120px"></canvas>
                            </article>
                        </div>
                    </div>

                    <div class="col-xl-4 col-lg-12">
                        <div class="card mb-4">
                            <article class="card-body">
                                <h5 class="card-title">Category sales</h5>
                                <% if(category.length > 0){ %>
                                    <% category.forEach((categories) => { %>
                                        <span class="text-muted font-xs"> <%= categories._id %> </span>
                                        <div class="progress mb-3">
                                            <div class="progress-bar" role="progressbar" style="width: <%=categories.total%> &"> <%=categories.total%></div>
                                        </div>
                                    <% }) %>
                                <% } %>
                            </article>
                        </div>
                    </div>

                </div>

               


            </section>
        </main>
        
        <!-- Button trigger modal -->

        <script src="/js/vendors/jquery-3.6.0.min.js"></script>
        <script src="/js/vendors/bootstrap.bundle.min.js"></script>
        <script src="/js/vendors/select2.min.js"></script>
        <script src="/js/vendors/perfect-scrollbar.js"></script>
        <script src="/js/vendors/jquery.fullscreen.min.js"></script>
        <script src="/js/main.js?v=1.1" type="text/javascript"></script>
        <script src="/js/custom-chart.js" type="text/javascript"></script>

        <script src="/js/vendors/chart.js"></script>
        <script>
        
        (function ($) {
            // for the x axis or the to list the year,month,week
                let arr = ['<%=list%>']
                let data = arr.join('')
                let dataArr = data.split(',');
            // for the y axis or to list the order count 
                let order = ['<%=yaxis%>']
                let orderData = order.join('')
                let orderCount = orderData.split(',');

            "use strict";
            /*Sale statistics Chart*/
            if ($('#myChart').length) {
                var ctx = document.getElementById('myChart').getContext('2d');
                    var chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'bar',
                    // The data for our dataset
                    data: { 
                        labels:dataArr,
                        datasets: [{
                                label: 'Orders',
                                tension: 0.3,
                                fill: true,
                                backgroundColor: 'rgba(44, 120, 220, 0.2)',
                                borderColor: 'rgba(44, 120, 220)',
                                data: orderCount,
                            },
                        ]
                    },
                    options: {
                        plugins: {
                        legend: {
                            labels: {
                            usePointStyle: true,
                            },
                        }
                        }
                        }
                    });
               
            } //End if


})(jQuery);

    let pastDate = document.getElementById('fromDate');
    let FutureDate = document.getElementById('toDate');
    let dateLabel = document.getElementById('date-label');
    let max = new Date().toISOString().split('T')[0];

    // Disabling the future dates
    pastDate.setAttribute('max',max)
    FutureDate.setAttribute('max',max)

    let Salesform = document.getElementById('downloadSalesForm')
    function downloadSalesReport(){
        if(pastDate.value < FutureDate.value){
            return Salesform.submit()
        }
        dateLabel.innerHTML = 'Invalid date'
    }

        $(document).on("click","#cust_btn",function(){

            $("#myModal").modal("toggle");
        
        })

        $(document).on("click","#close-button",function(){

            $("#myModal").modal("hide");
        
        })

    
      // Extract selected dates
      let fromDate = document.getElementById('fromDate').value;
      let toDate = document.getElementById('toDate').value;

      Salesform.addEventListener('submit',(e) => {
        $.ajax({
        type: 'GET',
        url: `/admin/downloadSalesReport?fromDate=${fromDate}&toDate=${toDate}`,
        // data: { fromDate: fromDate, toDate: toDate },
        success: function (data) {
            e.preventDefault()
            const blob = new Blob([data], { type: 'text/csv' });
            console.log(blob)
            // Create a link element to trigger the download
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = 'sales_report.csv';

            // Append the link to the body and trigger the click event
            document.body.appendChild(link);
            link.click();

            // Remove the link element
            document.body.removeChild(link);
            console.log('Sales report downloaded successfully', data)
          
        },
        error: function (error) {
          console.error('Error downloading sales report:', error.responseText);
        }
      });
      })
  
    let form = document.getElementById('chart-form')
    let button = document.getElementById('select-btn')
    button.addEventListener('change',(e) => {
        const selectedValue = e.target.value;

// Check if a valid option is selected
        if (selectedValue) {
        // Redirect to the selected URL
        
        window.location.href = selectedValue;
        }
    })

    
    

</script>
        <!-- Main Script -->
       

    </body>
</html>
